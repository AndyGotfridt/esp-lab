<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Reloj LED</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.1.0/css/all.css"/><link rel="stylesheet" href="style.css"><style> .collapsible-section { overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out; max-height: 500px; opacity: 1; } .collapsible-section.collapsed { max-height: 0; opacity: 0; margin: 0 !important; padding: 0 !important; } .fs-10 { font-size: 10px !important; } .fs-13 { font-size: 13px !important; } .fs-14 { font-size: 14px !important; } .fs-48 { font-size: 48px !important; } .preview-time { font-weight: bold; letter-spacing: 5px; } </style></head><body><div class="main-container"><div class="header-card"><div class="row align-items-center"><div class="col col-md-6 col-12 d-flex justify-content-center align-items-center"><h1><i class="fa-solid fa-clock"></i> RELOJ LED <span class="fs-10">by <strong>Andy Gotfridt</strong></span></h1></div><div class="col col-md-6 col-12 d-flex justify-content-center align-items-center gap-2"><span id="updateBadge" class="badge bg-warning text-dark d-none" style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#updateModal"><i class="fa-solid fa-circle-up"></i>&nbsp;<span id="updateVersion">UPDATE BADGE</span></span><span id="wifiStatus" class="badge bg-success"><i class="fa-solid fa-wifi"></i>&nbsp;<span id="wifiSSID">WIFI BADGE</span></span><button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#advancedModal" title="Configuración Avanzada"><i class="fa-solid fa-gear"></i></button><button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal" title="Configuración Avanzada"><i class="fa-solid fa-rectangle-beta"></i></button></div></div></div><div class="position-fixed top-0 end-0 p-3" style="z-index:9999"><div id="successToast" class="toast text-uppercase align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><i class="fa-solid fa-circle-check me-2"></i>¡Configuración guardada automáticamente! </div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div></div><div class="content-row"><div class="row h-100 g-3"><div class="col-lg-6"><div class="config-card"><div class="row mb-4"><div class="col col-md-6 col-12"><h2 class="section-title"><i class="fa-solid fa-palette"></i> Colores del Display</h2><div class="color-picker-wrapper"><label><i class="fa-solid fa-h"></i> Horas</label><input type="color" class="form-control" id="colorHours" value="#ff0000"></div><div class="color-picker-wrapper"><label><i class="fa-solid fa-circle"></i> Separador</label><input type="color" class="form-control" id="colorSeparator" value="#0000ff"></div><div class="color-picker-wrapper"><label><i class="fa-solid fa-m"></i> Minutos</label><input type="color" class="form-control" id="colorMinutes" value="#00ff00"></div></div><div class="col col-md-6 col-12"><h2 class="section-title"><i class="fa-solid fa-swatchbook"></i> Temas Rápidos</h2><div class="row g-2"><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FF0000','#FF0000','#FF0000')" style="background:linear-gradient(90deg,#FF0000 33%,#FF0000 66%,#FF0000)"><small>Clásico</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FF00FF','#00FFFF','#FFFF00')" style="background:linear-gradient(90deg,#FF00FF 33%,#00FFFF 66%,#FFFF00)"><small>Neón</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FF0000','#00FF00','#0000FF')" style="background:linear-gradient(90deg,#FF0000 33%,#00FF00 66%,#0000FF)"><small>Arcoíris</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#0066CC','#00CCFF','#66FFFF')" style="background:linear-gradient(90deg,#0066CC 33%,#00CCFF 66%,#66FFFF)"><small>Océano</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FF4500','#FF6347','#FF7F50')" style="background:linear-gradient(90deg,#FF4500 33%,#FF6347 66%,#FF7F50)"><small>Fuego</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#00FF00','#00FF00','#00FF00')" style="background:linear-gradient(90deg,#00FF00 33%,#00FF00 66%,#00FF00)"><small>Matrix</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#9932CC','#BA55D3','#DA70D6')" style="background:linear-gradient(90deg,#9932CC 33%,#BA55D3 66%,#DA70D6)"><small>Púrpura</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FFD700','#FFA500','#FF8C00')" style="background:linear-gradient(90deg,#FFD700 33%,#FFA500 66%,#FF8C00)"><small>Sunset</small></button></div><div class="col-4"><button type="button" class="btn w-100 theme-btn" onclick="applyTheme('#FFFFFF','#CCCCCC','#999999')" style="background:linear-gradient(90deg,#FFFFFF 33%,#CCCCCC 66%,#999999);border:1px solid #ddd"><small>Blanco</small></button></div></div></div></div><div class="mb-4"><p>el infiltrado</p><h2 class="section-title"><i class="fa-solid fa-eye"></i> Vista Previa</h2><div class="text-center p-4 bg-light rounded"><div id="previewTime" class="fs-48 preview-time"><span id="previewHours" style="color:#ff0000">23</span><span id="previewSeparator" style="color:#0000ff">:</span><span id="previewMinutes" style="color:#00ff00">45</span></div><small class="text-muted"><i class="fa-solid fa-clock"></i> Hora en tiempo real</small></div></div></div></div><div class="col-lg-6"><div class="config-card"><div class="row"><div class="col-md-6 col-12"><div class="mb-4"><h2 class="section-title"><i class="fa-solid fa-lightbulb"></i> Control de Brillo</h2><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="autobrightness" checked><label class="form-check-label" for="autobrightness"><i class="fa-solid fa-wand-magic-sparkles"></i> Brillo automático (sensor LDR)</label></div><div id="manualBrightnessControl" class="collapsible-section d-none"><div id="nightModeWarning" class="alert alert-warning d-flex align-items-start mb-3 d-none fs-13"><i class="fa-solid fa-moon me-2 mt-1"></i><div><strong>Modo nocturno activo:</strong> Los cambios de brillo manual no se aplicarán hasta que finalice el horario nocturno.</div></div><div class="slider-container"><div class="slider-label"><label class="form-label mb-0"><i class="fa-solid fa-brightness fa-lg"></i>&nbsp;Brillo manual</label><span class="slider-value" id="brightnessValue">128</span></div><input type="range" class="form-range" id="brightness" min="0" max="255" value="128"></div></div><div id="autoBrightnessControls" class="collapsible-section"><div class="toast-info d-flex align-items-center mb-3 fs-13"><i class="fa-solid fa-light-ceiling fa-lg me-2"></i><div class="flex-grow-1"><strong class="text-uppercase">Luz:</strong>&nbsp;<span id="ldrPercentage"></span>&nbsp;%</div><span class="badge bg-primary text-uppercase">Brillo:&nbsp;<strong id="currentBrightnessValue">--</strong></span></div><div class="slider-container"><div class="slider-label"><label class="form-label mb-0"><i class="fa-light fa-brightness fa-lg"></i>&nbsp;Brillo mínimo</label><span class="slider-value" id="minBrightnessValue">20</span></div><input type="range" class="form-range" id="minBrightness" min="0" max="255" value="20"></div><div class="slider-container"><div class="slider-label"><label class="form-label mb-0"><i class="fa-solid fa-brightness fa-lg"></i>&nbsp;Brillo máximo</label><span class="slider-value" id="maxBrightnessValue">255</span></div><input type="range" class="form-range" id="maxBrightness" min="0" max="255" value="255"></div></div></div></div><div class="col-md-6 col-12"><div class="mb-4"><h2 class="section-title"><i class="fa-solid fa-moon"></i>&nbsp;Modo Nocturno&nbsp;<i class="fa-solid fa-circle-info" data-bs-toggle="tooltip" data-bs-placement="bottom" title="El modo nocturno reduce el brillo automáticamente en el horario configurado"></i></h2><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="scheduleEnabled" checked><label class="form-check-label" for="scheduleEnabled">&nbsp;Habilitado</label></div><div class="row g-2 mb-2"><div class="col-12"><div class="slider-container"><div class="slider-label"><label class="form-label mb-0"><i class="fa-solid fa-brightness fa-lg"></i>&nbsp;Brillo nocturno</label><span class="slider-value" id="nightBrightnessValue">30</span></div><input type="range" class="form-range" id="nightBrightness" min="0" max="255" value="30"></div></div><div class="col-6"><label class="form-label fw-bold"><i class="fa-solid fa-clock"></i>&nbsp;Inicio</label><input type="time" class="form-control" id="timeOff" value="23:00"></div><div class="col-6"><label class="form-label fw-bold"><i class="fa-solid fa-clock"></i>&nbsp;Fin</label><input type="time" class="form-control" id="timeOn" value="07:00"></div></div></div></div><div class="col-12"><div class="d-grid"><button type="button" class="btn btn-success btn-lg" onclick="saveConfig()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Los cambios se guardan automáticamente después de 500ms"><i class="fa-solid fa-floppy-disk"></i> Guardar Configuración </button></div></div></div></div></div></div></div></div><footer class="text-center py-3 text-white-50 fs-14">Desarrollado con <i class="fa-solid fa-heart" style="color:#ff6b6b;animation:heartbeat 1.5s ease-in-out infinite"></i> por <strong>Andy Gotfridt</strong> v<strong id="footerVersion"><i class="fa-solid fa-spinner fa-spin"></i></strong></footer><div class="modal fade" id="advancedModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header" style="background:var(--primary-gradient);color:white"><h5 class="modal-title"><i class="fa-solid fa-gear"></i> Configuración</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-6 col-12"><h6 class="text-muted mb-3"><i class="fa-solid fa-earth-americas"></i> Zona Horaria</h6><label class="form-label"><i class="fa-solid fa-globe"></i> Selecciona tu zona horaria</label><input type="text" class="form-control mb-2 fs-14" id="timezoneSearch" placeholder="Buscar ciudad o país..."><select class="form-select fs-14 mb-3" id="timezoneSelect" size="6"><optgroup label="América"><option value="-10">Hawaii (GMT-10)</option><option value="-8">Los Angeles, Vancouver (GMT-8)</option><option value="-7">Denver, Phoenix (GMT-7)</option><option value="-6">Ciudad de México, Chicago (GMT-6)</option><option value="-5">Bogotá, Lima, Nueva York (GMT-5)</option><option value="-4">Caracas, La Paz, Santiago (GMT-4)</option><option value="-3" selected>Buenos Aires, São Paulo (GMT-3)</option><option value="-2">Mid-Atlantic (GMT-2)</option></optgroup><optgroup label="Europa & África"><option value="0">Londres, Lisboa (GMT+0)</option><option value="1">Madrid, París, Berlín (GMT+1)</option><option value="2">Atenas, El Cairo, Johannesburgo (GMT+2)</option><option value="3">Moscú, Nairobi (GMT+3)</option></optgroup><optgroup label="Asia & Oceanía"><option value="4">Dubai (GMT+4)</option><option value="5">Islamabad, Karachi (GMT+5)</option><option value="5.5">Mumbai, New Delhi (GMT+5:30)</option><option value="7">Bangkok, Jakarta (GMT+7)</option><option value="8">Beijing, Hong Kong, Singapur (GMT+8)</option><option value="9">Tokyo, Seúl (GMT+9)</option><option value="10">Sydney, Melbourne (GMT+10)</option><option value="12">Auckland (GMT+12)</option></optgroup></select><input type="hidden" id="timezoneOffset" value="-3"><div class="mt-3"><label class="form-label"><i class="fa-sharp fa-solid fa-server"></i>&nbsp;Servidor NTP</label><input type="text" class="form-control fs-14" id="ntpServer" value="pool.ntp.org" placeholder="pool.ntp.org"><small class="text-muted">Servidor para sincronización de hora</small></div></div><div class="col-md-6 col-12"><div class="toast-warning d-flex align-items-start mb-3 fs-13"><i class="fa-solid fa-triangle-exclamation me-2 mt-1"></i><p class="text-uppercase m-0"><strong>Advertencia:</strong> Cambiar los pines requiere reiniciar el ESP32 y reconectar el hardware correctamente.</p></div><h6 class="text-muted mb-3"><i class="fa-solid fa-microchip"></i> Pines de Hardware</h6><div class="row g-3 mb-3"><div class="col-6"><label class="form-label fw-bold"><i class="fa-solid fa-lightbulb"></i> Pin LEDs</label><input type="number" class="form-control" id="ledPin" value="2" min="0" max="10"><small class="text-muted">GPIO: 0-7, 10</small></div><div class="col-6"><label class="form-label fw-bold"><i class="fa-solid fa-sun"></i> Pin LDR</label><input type="number" class="form-control" id="ldrPin" value="0" min="0" max="4"><small class="text-muted">ADC: 0-4</small></div></div><div class="mb-3"><label class="form-label fw-bold"><i class="fa-solid fa-list-ol"></i> Total de LEDs</label><input type="number" class="form-control" id="numLeds" value="62" min="1" max="500"><small class="text-muted">Cantidad total de LEDs en tu tira</small><button type="button" class="btn btn-outline-primary w-100 text-uppercase mt-1" onclick="testLeds()"><i class="fa-solid fa-lightbulb"></i>&nbsp;Test LEDs </button></div></div></div><hr><h6 class="text-muted mb-3"><i class="fa-solid fa-wifi"></i> Red WiFi</h6><button type="button" class="btn btn-outline-danger w-100 mb-3" onclick="resetWifi()" data-bs-dismiss="modal"><i class="fa-solid fa-rotate-right"></i> Reconfigurar WiFi </button></div><div class="modal-footer"><button type="button" class="btn btn-mg btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i> Cerrar</button><button type="button" class="btn btn-md btn-success" onclick="saveAdvancedConfig()" data-bs-dismiss="modal"><i class="fa-solid fa-floppy-disk"></i> Guardar Cambios</button></div></div></div></div><div class="modal fade" id="updateModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white"><h5 class="modal-title"><i class="fa-solid fa-circle-up"></i> Nueva Versión Disponible</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="text-center mb-3"><h3 class="mb-1">Versión <span id="updateNewVersion">--</span></h3><small class="text-muted">Versión actual: <strong id="updateCurrentVersion">--</strong></small></div><div class="mb-3"><p class="fs-4 text-uppercase">Changelog</p><code id="updateReleaseNotes" class="mt-2"> Cargando información... </code></div><hr><div class="toast-warning mb-3 fs-13"><i class="fa-solid fa-info-circle"></i>&nbsp;Se instalará el firmware automáticamente desde GitHub. No desconectes el dispositivo durante el proceso (~60 segundos). </div><div class="d-grid gap-2"><button type="button" class="btn btn-success btn-lg" id="updateAutoBtn" onclick="autoUpdateFirmware()"><i class="fa-solid fa-bolt"></i> Actualizar Automáticamente </button><a id="updateDownloadBtn" href="#" target="_blank" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-download"></i> Descargar .bin (opcional) </a></div><div id="updateProgress" class="d-none mb-3"><div class="progress" style="height: 25px;"><div id="updateProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div></div><small id="updateStatus" class="text-muted d-block mt-2">Iniciando actualización...</small></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Más tarde</button></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script> let DEVICE = null; document.addEventListener('DOMContentLoaded', function() { var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')); var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); }); }); function toggleBrightnessControls() { var isAutoEnabled = document.getElementById('autobrightness').checked; var manualControl = document.getElementById('manualBrightnessControl'); var autoControls = document.getElementById('autoBrightnessControls'); if (isAutoEnabled) { manualControl.classList.add('collapsed'); autoControls.classList.remove('collapsed'); setTimeout(function() { manualControl.classList.add('d-none'); }, 300); } else { manualControl.classList.remove('d-none'); manualBrightnessControl.classList.remove('d-none'); setTimeout(function() { manualControl.classList.remove('collapsed'); }, 10); autoControls.classList.add('collapsed'); } } document.getElementById('autobrightness').addEventListener('change', function() { toggleBrightnessControls(); checkNightMode(); updateLdrValue(); autoSave(); }); function checkNightMode() { var autobrightness = document.getElementById('autobrightness').checked; var scheduleEnabled = document.getElementById('scheduleEnabled').checked; var manualControl = document.getElementById('manualBrightnessControl'); var warning = document.getElementById('nightModeWarning'); if (manualControl.style.display === 'none' || !scheduleEnabled) { warning.classList.add('d-none'); return; } var timeOff = document.getElementById('timeOff').value.split(':'); var timeOn = document.getElementById('timeOn').value.split(':'); var hourOff = parseInt(timeOff[0]); var minuteOff = parseInt(timeOff[1]); var hourOn = parseInt(timeOn[0]); var minuteOn = parseInt(timeOn[1]); var now = new Date(); var currentMinutes = now.getHours() * 60 + now.getMinutes(); var offMinutes = hourOff * 60 + minuteOff; var onMinutes = hourOn * 60 + minuteOn; var isNightMode = false; if (onMinutes < offMinutes) { isNightMode = (currentMinutes < onMinutes || currentMinutes >= offMinutes); } else { isNightMode = (currentMinutes >= offMinutes && currentMinutes < onMinutes); } if (isNightMode) { warning.classList.remove('d-none'); } else { warning.classList.add('d-none'); } } setInterval(checkNightMode, 60000); checkNightMode(); document.getElementById('scheduleEnabled').addEventListener('change', function() { checkNightMode(); autoSave(); }); document.getElementById('timeOff').addEventListener('change', function() { checkNightMode(); autoSave(); }); document.getElementById('timeOn').addEventListener('change', function() { checkNightMode(); autoSave(); }); document.getElementById('brightness').addEventListener('input',function(){ document.getElementById('brightnessValue').textContent=this.value; autoSave(); }); document.getElementById('minBrightness').addEventListener('input',function(){ document.getElementById('minBrightnessValue').textContent=this.value; autoSave(); }); document.getElementById('maxBrightness').addEventListener('input',function(){ document.getElementById('maxBrightnessValue').textContent=this.value; autoSave(); }); document.getElementById('nightBrightness').addEventListener('input',function(){ document.getElementById('nightBrightnessValue').textContent=this.value; autoSave(); }); document.getElementById('colorHours').addEventListener('input',function(){ updatePreview(); autoSave(); }); document.getElementById('colorMinutes').addEventListener('input',function(){ updatePreview(); autoSave(); }); document.getElementById('colorSeparator').addEventListener('input',function(){ updatePreview(); autoSave(); }); function updatePreview(){ var now=new Date(); var h=String(now.getHours()).padStart(2,'0'); var m=String(now.getMinutes()).padStart(2,'0'); var hc=document.getElementById('colorHours').value; var mc=document.getElementById('colorMinutes').value; var sc=document.getElementById('colorSeparator').value; document.getElementById('previewHours').textContent=h; document.getElementById('previewHours').style.color=hc; document.getElementById('previewSeparator').textContent=':'; document.getElementById('previewSeparator').style.color=sc; document.getElementById('previewMinutes').textContent=m; document.getElementById('previewMinutes').style.color=mc; } setInterval(updatePreview,1000); updatePreview(); function applyTheme(h,m,s){ document.getElementById('colorHours').value=h; document.getElementById('colorMinutes').value=m; document.getElementById('colorSeparator').value=s; updatePreview(); autoSave(); } document.getElementById('timezoneSelect').addEventListener('change',function(){ document.getElementById('timezoneOffset').value=this.value; }); document.getElementById('timezoneSearch').addEventListener('input',function(){ var filter=this.value.toLowerCase(); var opts=document.querySelectorAll('#timezoneSelect option'); var optgroups=document.querySelectorAll('#timezoneSelect optgroup'); for(var i=0;i<optgroups.length;i++){optgroups[i].style.display=''} for(var i=0;i<opts.length;i++){ var text=opts[i].textContent.toLowerCase(); if(text.indexOf(filter)>-1||filter===''){opts[i].style.display=''}else{opts[i].style.display='none'} } }); var autoSaveTimer; function autoSave(){ clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(function(){ saveConfig(true); },500); } function saveConfig(silent){ var timeOn = document.getElementById('timeOn').value.split(':'); var timeOff = document.getElementById('timeOff').value.split(':'); var config = { colorHours: parseInt(document.getElementById('colorHours').value.replace('#',''), 16), colorMinutes: parseInt(document.getElementById('colorMinutes').value.replace('#',''), 16), colorSeparator: parseInt(document.getElementById('colorSeparator').value.replace('#',''), 16), brightness: parseInt(document.getElementById('brightness').value), autobrightness: document.getElementById('autobrightness').checked, minBrightness: parseInt(document.getElementById('minBrightness').value), maxBrightness: parseInt(document.getElementById('maxBrightness').value), scheduleEnabled: document.getElementById('scheduleEnabled').checked, hourOn: parseInt(timeOn[0]), minuteOn: parseInt(timeOn[1]), hourOff: parseInt(timeOff[0]), minuteOff: parseInt(timeOff[1]), nightBrightness: parseInt(document.getElementById('nightBrightness').value), timezoneOffset: parseFloat(document.getElementById('timezoneOffset').value), ntpServer: document.getElementById('ntpServer').value }; fetch('/saveConfig', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) }) .then(response => response.text()) .then(data => { var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); toastBody.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i>¡Cambios guardados'; var toast = new bootstrap.Toast(toastEl, { autohide: true, delay: silent ? 1500 : 3500 }); toast.show(); }) .catch(err => { console.error('[SAVE-CONFIG] ERROR:', err); var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); toastBody.innerHTML = '<i class="fa-solid fa-circle-xmark me-2"></i>Error al guardar'; toastEl.className = 'toast align-items-center text-white bg-danger border-0'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3500}); toast.show(); setTimeout(function(){ toastEl.className = 'toast align-items-center text-white bg-success border-0'; }, 3500); }); } function saveAdvancedConfig(){ var timeOn = document.getElementById('timeOn').value.split(':'); var timeOff = document.getElementById('timeOff').value.split(':'); var fullConfig = { colorHours: parseInt(document.getElementById('colorHours').value.replace('#',''), 16), colorMinutes: parseInt(document.getElementById('colorMinutes').value.replace('#',''), 16), colorSeparator: parseInt(document.getElementById('colorSeparator').value.replace('#',''), 16), brightness: parseInt(document.getElementById('brightness').value), autobrightness: document.getElementById('autobrightness').checked, minBrightness: parseInt(document.getElementById('minBrightness').value), maxBrightness: parseInt(document.getElementById('maxBrightness').value), scheduleEnabled: document.getElementById('scheduleEnabled').checked, hourOn: parseInt(timeOn[0]), minuteOn: parseInt(timeOn[1]), hourOff: parseInt(timeOff[0]), minuteOff: parseInt(timeOff[1]), nightBrightness: parseInt(document.getElementById('nightBrightness').value), timezoneOffset: parseFloat(document.getElementById('timezoneOffset').value), ntpServer: document.getElementById('ntpServer').value, ledPin: parseInt(document.getElementById('ledPin').value), ldrPin: parseInt(document.getElementById('ldrPin').value), numLeds: parseInt(document.getElementById('numLeds').value) }; fetch('/saveConfig', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(fullConfig) }) .then(response => response.text()) .then(data => { var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); if (data === 'OK_RESTART') { toastBody.innerHTML = '<i class="fa-solid fa-rotate me-2"></i>¡Guardado! El ESP32 se reiniciará...'; toastEl.className = 'toast align-items-center text-white bg-warning border-0'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 5000}); toast.show(); setTimeout(function(){ toastEl.className = 'toast align-items-center text-white bg-success border-0'; }, 5000); } else { toastBody.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i>¡Cambios guardados!'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3500}); toast.show(); } }) .catch(err => { console.error('[SAVE-MODAL] ERROR: ', err); var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); toastBody.innerHTML = '<i class="fa-solid fa-circle-xmark me-2"></i>Error al guardar'; toastEl.className = 'toast align-items-center text-white bg-danger border-0'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3500}); toast.show(); setTimeout(function(){ toastEl.className = 'toast align-items-center text-white bg-success border-0'; }, 3500); }); } function resetWifi(){ if(confirm('¿Estás seguro? Se borrarán las credenciales WiFi y el ESP32 se reiniciará.')){ alert('WiFi reseteado. El dispositivo se reiniciará.'); } } function testLeds(){ if(confirm('Se ejecutará un test de ~8 segundos probando todos los colores. ¿Continuar?')){ var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); toastBody.innerHTML = '<i class="fa-solid fa-vial me-2"></i>Ejecutando test de LEDs...'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 2000}); toast.show(); fetch('/testLeds') .then(response => response.text()) .then(data => { setTimeout(function(){ toastBody.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i>Test completado!'; toast.show(); }, 8000); }) .catch(err => { console.error('[TEST] ERROR:', err); toastBody.innerHTML = '<i class="fa-solid fa-circle-xmark me-2"></i>Error en test'; toastEl.className = 'toast align-items-center text-white bg-danger border-0'; toast.show(); setTimeout(function(){ toastEl.className = 'toast align-items-center text-white bg-success border-0'; }, 3500); }); } } function autoUpdateFirmware() { var firmwareUrl = window.latestFirmwareUrl; var webAssets = window.latestWebAssets || []; if (!firmwareUrl || firmwareUrl === '#') { alert('No hay URL de descarga disponible. Verifica tu conexión.'); return; } var confirmMsg = 'El ESP32 descargará y actualizará:\n\n'; confirmMsg += '• Firmware (.bin)\n'; if (webAssets.length > 0) { confirmMsg += '• Archivos web (' + webAssets.length + ')\n'; } confirmMsg += '\n⚠️ NO desconectes el ESP32 durante el proceso (~60-90 seg)'; if (!confirm(confirmMsg)) { return; } var progressDiv = document.getElementById('updateProgress'); var progressBar = document.getElementById('updateProgressBar'); var statusText = document.getElementById('updateStatus'); var autoBtn = document.getElementById('updateAutoBtn'); progressDiv.classList.remove('d-none'); autoBtn.disabled = true; autoBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Actualizando...'; progressBar.style.width = '10%'; progressBar.textContent = '10%'; progressBar.classList.add('progress-bar-animated'); if (webAssets.length > 0) { statusText.textContent = 'Actualizando archivos web (' + webAssets.length + ')...'; var filePromises = webAssets.map(function(asset) { return fetch('/updateFile?url=' + encodeURIComponent(asset.url) + '&path=' + encodeURIComponent(asset.path)) .then(response => response.text()) .then(data => { console.log('Archivo actualizado:', asset.path); }); }); Promise.all(filePromises) .then(function() { progressBar.style.width = '40%'; progressBar.textContent = '40%'; return updateFirmwareStep(firmwareUrl, progressBar, statusText, autoBtn); }) .catch(err => { console.error('[AUTO-UPDATE] ERROR:', err); progressBar.classList.add('bg-danger'); statusText.textContent = '✗ Error: ' + err.message; autoBtn.disabled = false; autoBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Reintentar'; }); } else { updateFirmwareStep(firmwareUrl, progressBar, statusText, autoBtn) .catch(err => { console.error('[AUTO-UPDATE] ERROR:', err); progressBar.classList.add('bg-danger'); statusText.textContent = '✗ Error: ' + err.message; autoBtn.disabled = false; autoBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Reintentar'; }); } } function updateFirmwareStep(firmwareUrl, progressBar, statusText, autoBtn) { statusText.textContent = 'Descargando firmware...'; return fetch('/updateAuto?url=' + encodeURIComponent(firmwareUrl)) .then(response => response.text()) .then(data => { if (data.includes('Starting')) { progressBar.style.width = '75%'; progressBar.textContent = '75%'; statusText.textContent = 'ESP32 instalando firmware... (~30 segundos)'; return new Promise((resolve) => { setTimeout(function() { progressBar.classList.remove('progress-bar-animated'); progressBar.classList.add('bg-success'); progressBar.style.width = '100%'; progressBar.textContent = '100%'; statusText.textContent = '✓ Actualización completada! El ESP32 se reiniciará...'; setTimeout(function() { var modal = bootstrap.Modal.getInstance(document.getElementById('updateModal')); modal.hide(); var toastEl = document.getElementById('successToast'); var toastBody = toastEl.querySelector('.toast-body'); toastBody.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i>Firmware actualizado! Reconectando...'; var toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 5000}); toast.show(); setTimeout(function() { location.reload(); }, 10000); }, 2000); resolve(); }, 30000); }); } else { throw new Error('Error al iniciar actualización'); } }); } function updateWifiStatus(){ fetch('/getWifiStatus') .then(r => r.json()) .then(data => { var statusBadge = document.getElementById('wifiStatus'); var ssidSpan = document.getElementById('wifiSSID'); if(data.connected){ statusBadge.className = 'badge bg-success'; ssidSpan.textContent = data.ssid; } else { statusBadge.className = 'badge bg-danger'; ssidSpan.textContent = 'Desconectado'; } }) .catch(err => { console.error('[GET-WIFI] ERROR:', err); var statusBadge = document.getElementById('wifiStatus'); var ssidSpan = document.getElementById('wifiSSID'); statusBadge.className = 'badge bg-danger'; ssidSpan.textContent = 'Error'; }); } function updateLdrValue(){ var isAutoEnabled = document.getElementById('autobrightness').checked; if(!isAutoEnabled) return; fetch('/getLdrValue') .then(r => r.json()) .then(data => { document.getElementById('ldrPercentage').textContent = data.percentage; document.getElementById('currentBrightnessValue').textContent = data.brightness; }) .catch(err => { console.error('[LDR] ERROR: ', err); document.getElementById('ldrPercentage').textContent = '--'; document.getElementById('currentBrightnessValue').textContent = '--'; }); } function loadConfig() { fetch('/getConfig') .then(r => r.json()) .then(config => { document.getElementById('colorHours').value = '#' + config.colorHours.toString(16).padStart(6, '0'); document.getElementById('colorMinutes').value = '#' + config.colorMinutes.toString(16).padStart(6, '0'); document.getElementById('colorSeparator').value = '#' + config.colorSeparator.toString(16).padStart(6, '0'); document.getElementById('brightness').value = config.brightness; document.getElementById('brightnessValue').textContent = config.brightness; document.getElementById('autobrightness').checked = config.autobrightness; document.getElementById('minBrightness').value = config.minBrightness; document.getElementById('minBrightnessValue').textContent = config.minBrightness; document.getElementById('maxBrightness').value = config.maxBrightness; document.getElementById('maxBrightnessValue').textContent = config.maxBrightness; document.getElementById('scheduleEnabled').checked = config.scheduleEnabled; document.getElementById('timeOn').value = String(config.hourOn).padStart(2, '0') + ':' + String(config.minuteOn).padStart(2, '0'); document.getElementById('timeOff').value = String(config.hourOff).padStart(2, '0') + ':' + String(config.minuteOff).padStart(2, '0'); document.getElementById('nightBrightness').value = config.nightBrightness; document.getElementById('nightBrightnessValue').textContent = config.nightBrightness; document.getElementById('timezoneOffset').value = config.timezoneOffset; document.getElementById('timezoneSelect').value = config.timezoneOffset; if (config.ntpServer) { document.getElementById('ntpServer').value = config.ntpServer; } if (config.ledPin !== undefined) { document.getElementById('ledPin').value = config.ledPin; } if (config.ldrPin !== undefined) { document.getElementById('ldrPin').value = config.ldrPin; } if (config.numLeds !== undefined) { document.getElementById('numLeds').value = config.numLeds; } setTimeout(function() { updatePreview(); toggleBrightnessControls(); checkNightMode(); }, 50); }) .catch(err => console.error('[CONFIG] ERROR:', err)); } let CURRENT_VERSION = null; let FIRMWARE_CHANNEL = null; function compareVersions(v1, v2) { const parts1 = v1.split('.').map(Number); const parts2 = v2.split('.').map(Number); for (let i = 0; i < 3; i++) { if (parts1[i] > parts2[i]) return 1; if (parts1[i] < parts2[i]) return -1; } return 0; } function loadVersionInfo(testMode = false) { fetch('/getDeviceInfo') .then(r => r.json()) .then(data => { CURRENT_VERSION = data.version; FIRMWARE_CHANNEL = data.channel || 'stable'; document.getElementById('footerVersion').textContent = data.version; document.getElementById('updateCurrentVersion').textContent = data.version; if (data.updateServer) { window.UPDATE_SERVER_URL = data.updateServer; } DEVICE = data; if(testMode){ console.warn('====== SANDBOX MODE | DEBUGGING ======'); console.warn('FIRMWARE V:', DEVICE.version); console.warn('FIRMWARE C:', DEVICE.channel); console.warn('MAC:', DEVICE.mac); console.warn('DEVICE ID:', DEVICE.device); console.warn('HOSTNAME:', DEVICE.hostname); console.warn('UPDATE SERVER:', data.updateServer); console.warn('===================================='); } }) .catch(err => { console.error('[VERSION] ERROR:', err); }); } function checkForUpdates() { if (!window.UPDATE_SERVER_URL) { console.warn('[UPDATES] No update server URL configured. Skipping update check.'); return; } fetch(window.UPDATE_SERVER_URL + '?tstamp=' + Date.now()) .then(r => r.json()) .then(data => { let latestVersion, releaseNotes, downloadUrl, webAssets = []; if (data.tag_name) { latestVersion = data.tag_name.replace(/^v/, ''); releaseNotes = data.body || 'Sin notas de versión'; const binAsset = data.assets.find(a => a.name.endsWith('.bin')); downloadUrl = binAsset ? binAsset.browser_download_url : data.html_url; data.assets.forEach(function(asset) { if (asset.name === 'index.html') { webAssets.push({ name: asset.name, url: asset.browser_download_url, path: '/index.html' }); } else if (asset.name === 'style.css') { webAssets.push({ name: asset.name, url: asset.browser_download_url, path: '/style.css' }); } }); console.log('[UPDATES] GitHub Releases - Assets found:', webAssets.length); } else if (data.channels) { const channelData = data.channels[FIRMWARE_CHANNEL]; if (!channelData) { console.error('[UPDATES] Canal "' + FIRMWARE_CHANNEL + '" no encontrado en updates.json'); console.error('[UPDATES] Canales disponibles:', Object.keys(data.channels).join(', ')); return; } latestVersion = channelData.version; releaseNotes = channelData.releaseNotes || 'Sin notas de versión'; downloadUrl = channelData.downloadUrl; webAssets = channelData.webAssets || []; console.log('[UPDATES] Canal:', FIRMWARE_CHANNEL); console.log('[UPDATES] Versión disponible:', latestVersion); console.log('[UPDATES] Web assets:', webAssets.length); } else { console.error('[UPDATES] Formato de respuesta desconocido'); return; } window.latestFirmwareUrl = downloadUrl; window.latestWebAssets = webAssets; if (compareVersions(latestVersion, CURRENT_VERSION) > 0) { document.getElementById('updateBadge').classList.remove('d-none'); document.getElementById('updateVersion').innerText = `UPDATE v${latestVersion}`; document.getElementById('updateNewVersion').textContent = latestVersion; document.getElementById('updateCurrentVersion').textContent = CURRENT_VERSION; document.getElementById('updateReleaseNotes').innerHTML = releaseNotes.replace(/\n/g, '<br>'); document.getElementById('updateDownloadBtn').href = downloadUrl; } else { console.log('[UPDATES] Sistema actualizado. Versión actual:', CURRENT_VERSION); } }) .catch(err => { console.error('[UPDATES] ERROR:', err); }); } function getTestIP() { const urlParams = new URLSearchParams(window.location.search); return urlParams.get('ip'); } function getBaseURL() { const testIP = getTestIP(); if (testIP) { return 'http://' + testIP; } return ''; } const originalFetch = window.fetch; window.fetch = function(url, options) { if (typeof url === 'string' && url.startsWith('/')) { url = getBaseURL() + url; } return originalFetch(url, options); }; if (window.location.hostname !== '' || getTestIP()) { const testIP = getTestIP(); loadVersionInfo(testIP); loadConfig(); updateWifiStatus(); updateLdrValue(); setTimeout(checkForUpdates, 2000); setInterval(updateWifiStatus, 10000); setInterval(updateLdrValue, 2000); setInterval(checkForUpdates, 3600000); }</script></body></html>